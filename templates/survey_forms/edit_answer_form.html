{% extends 'base.html' %}
{% block contents %}
{% load urs_tags %}
{% load orderq %}

<div class="row">
    <div class="col-12">
        {% if ben_uuid and response_obj.survey.id != 2 %}
        <div style="background-color: #DBD4FE; padding: 10px; ">
            <h5 class="m-0"><b>School Details</b></h5>
        </div>
        <div class="card">
            <div class="card-body">
                {% include "../survey_forms/profile.html" %}
            </div>
        </div>
        {% endif %}
        <div class="card">
            <div class="card-body">
                {% include 'survey_forms/questions.html' %}
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {

        $('[name="563"]').attr('disabled', true)
        var json_data={{json_response|safe}}

        if (json_data['5'] == '273' && '{{is_first_record}}' == 'True' ){
            $('#666').find('option[value="650"]').remove()
        }
        //static validation for hiv form hide the question (In Case of PPW inmate Linked with PPTCT) 
        //if('{{gender_male}}' == 'True'){
        //    $('#skip_139').remove()
        //}

        // if('{{disable}}' == 'True'){
        //     disable_edit_fields()
        //     $(':submit').hide()
        // }
        {% with survey_slug|make_string:"edit" as keystrings %}
            {% if request|has_permission_for_action:keystrings|safe == 'False' %}
                $('.enable').remove()
            {% endif %}
        {% endwith %}

        $('.enable').click(function(){
            $(this).hide()
            $(':submit').show()
            enable_edit_fields()
        });

        //disable the fields in weekly inmate data form
        /*var disable_fields={{survey.extra_config.custom_page.questions}}
        $(disable_fields).each(function(index) {
            $('#'+disable_fields[index]).attr('disabled', true)
        })*/

        all_response={{response_obj.response|safe}}
        // if (all_response['616'] == '618'){
        //     disable_edit_fields()
        //     $(':submit').hide()
        // }
        question_ids_list = {{question_ids_list}}
        question_ids=Object.keys(all_response).reverse()
        //for(var i = 0; i < question_ids_list; i++) {
        $(question_ids_list).each(function(i, ele) {
            //TODO: try to merge both table and non table fields(reuse the code below conditions in both)
            //If condition for grid questions and normal questions
            if($('#'+ele).is('table')){
                //debugger
                if($('#'+ele).attr('name') == 'inline_question'){
                    $('#'+ele).find("input[type='date']").attr('type','text')
                    $.each(all_response[ele], function(index, element) {
                        q_ids=null
                        if(104 in element && element[104] == '50'){
                            $('#104').closest('td').next().find('#skip_105').show()
                            $("[name='group-100["+index+"][105]']").show()
                        }
                    })
                    rep=$('#'+ele).repeater()
                    rep.setList(all_response[ele] || {'':''})
                    $.each(all_response[ele], function(index, innerObj) {
                        
                        key = Object.keys(innerObj)[0]
                        obj_len = Object.keys(all_response[ele]).length
                    // Check if the key 352 exists in the inner object
                        if (innerObj.hasOwnProperty(key)) {
                            // Push the value associated with key 352 to the array
                            $('#'+ele).find("[name='group-"+ele+"["+index+"]["+key+"]']").attr('type','date')
                            var date_vlu = `${innerObj[key].split('-')[2]}-${innerObj[key].split('-')[1]}-${innerObj[key].split('-')[0]}`;
                            var date = new Date(date_vlu);
                            $('#'+ele).find("[name='group-"+ele+"["+index+"]["+key+"]']").val(date_vlu)
                            date.setDate(date.getDate() + 1);
                            var nextDay = date.toISOString().split('T')[0];
                            var next_index = parseInt(index)+1
                            var index_first_vlu = $("[name='group-"+ele+"[0]["+key+"]']").val()
                            $("[name='group-"+ele+"["+next_index+"]["+key+"]']").attr('min',nextDay)
                            $("[name='group-"+ele+"[0]["+key+"]']").attr('min',index_first_vlu)
                            if (obj_len != 1 && parseInt(index) != 0){
                                var top_date = new Date(date_vlu);
                                top_date.setDate(top_date.getDate() - 1);
                                var Above_Day = top_date.toISOString().split('T')[0];
                                var top_index = parseInt(index)-1
                                $("[name='group-"+ele+"["+top_index.toString()+"]["+key+"]']").attr('max',Above_Day)
                            }
                        }
                    });
                }else{
                    grid_question_ids=Object.keys(all_response[ele] || [])
                    for(var j = 0; j < grid_question_ids.length; j++){
                        keys_grid=all_response[ele][grid_question_ids[j]]
                        for(var k = 0; k < Object.keys(keys_grid).length; k++){
                            element=$('.'+grid_question_ids[j]+'_'+Object.keys(keys_grid)[k])
                            if(element.is("select")){
                                element.val(all_response[ele][grid_question_ids[j]][Object.keys(keys_grid)[k]]).trigger('change')
                            }else{
                                $(element).val(all_response[ele][grid_question_ids[j]][Object.keys(keys_grid)[k]])
                            }
                        }
                    }
                }
            }else{
                element=$('#'+ele)
                if ($('.address_widget').length > 0 && $('.address_widget').prop('name') == ele) {

                    //$('.address_widget').each(function( index ,element) {
                        $(".address_widget").each(function(indx) {
                            ids=this.id.split("_")
                            if (typeof window['adres_widget_'+ids[1]] === 'function' ){
                                window['adres_widget_'+ids[1][0]](all_response['address'][1][this.name][1],all_response['address'][1][this.name][2])
                                $(this).find('[value="'+all_response['address'][1][this.name][indx+1]+'"').prop("selected", true)
                            }else{
                                $(this).val(all_response['address'][1][this.name][indx+1]).trigger('change',[all_response['address'][1][this.name][indx+1]])
                            }
                        })

                    //})
                }else if(element.is("select")){
                    //calling the function for load child dropdown choices
                    if (typeof window['parent_dropdown_'+ele] === 'function' ){
                        window['parent_dropdown_'+ele](all_response[ele])
                    }
                    if (typeof window['child_dropdown_'+ele] === 'function' ){
                        window['child_dropdown_'+ele](all_response[ele],all_response)
                    }
                    $('<input>').attr('type','hidden').attr('id',ele+'_hidden').val(all_response[ele]).appendTo('#survey')
                    if (all_response[ele] != '' && all_response[ele] != undefined ){
                        try{
                            $(element).val(JSON.parse(all_response[ele])).trigger('change')
                        }catch(error){
                            $(element).val(all_response[ele]).trigger('change');
                        }
                    }
                }else if(element.is(":checkbox")){
                    if(all_response[ele] && all_response[ele].length > 0){
                        $.each(JSON.parse(all_response[ele]), function(i, val){
                            $("input[value='" + val + "']").prop('checked', true)
                            $("input[value='" + val + "']").trigger('change')
                        })
                    }
                }else if ((element.attr('type') == 'date' || element.attr('type') == 'month') && (all_response[ele] != '' && all_response[ele] != undefined )){
                    var dateParts = all_response[ele].split("-"); 
                    if (element.attr('type') == 'month'){
                        var newDate = dateParts[1] + "-" + dateParts[0];
                    }else{
                        var newDate = dateParts[2] + "-" + dateParts[1] + "-" + dateParts[0];
                    }
                    $(element).val(newDate)
                }else if (element.is(":radio") && all_response[ele]){
                    $("input[value='" + all_response[ele] + "']").prop('checked', true)
                    $("input[value='" + all_response[ele] + "']").trigger('change')
                }
                else{
                    $(element).val(all_response[ele])
                }
            }
            //ele=document.getElementById(question_ids[i])
        })

        // added validations Type of Inmate choices based on facility type 
        //72 = Type of Facility
        //368 = Prison
        //369 = OCS
        //61 = Type of Inmate
        //356 = CV
        //357 = UT
        //358 = CSR
        if (json_data['72'] == '368'){
            //$('#61').val('')
            $('#61 option[value="358"]').prop('disabled', true);
            $('#61 option[value="356"]').prop('disabled', false);
            $('#61 option[value="357"]').prop('disabled', false);
        }else if(json_data['72'] == '369'){
            //$('#61').val('')
            $('#61 option[value="358"]').prop('disabled', false);
            $('#61 option[value="356"]').prop('disabled', true);
            $('#61 option[value="357"]').prop('disabled', true);
        }
    });

        
    $('.delete_button').on('click', function() {
        var id=$(this).attr('id')
        $.get('/masterdata/delete/'+id+'/?list=true', function(data){
            var htmlContent = "<ul class='list-unstyled'>";
            for (var i = 0; i < data['list'].length; i++) {
                htmlContent += "<li>" + data['list'][i]['survey__name'] + ": " + data['list'][i]['record_count'] + "</li>";
            }
            htmlContent += "</ul>";
            Swal.fire({
                title: "Are you sure you want to delete ? <br> You won't be able to revert this!",
                icon: 'warning',
                html: htmlContent,  
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, delete it!'
            })
            .then((result) => {
                if (result.isConfirmed) {
                    $.get('/masterdata/delete/'+id+'/?uid={{request.user.id}}&delete=true', function(data){
                        if (data['status'] == 0){
                            Swal.fire({icon: 'error',title: 'Oops...',text: data['message']})
                        }else{
                            Swal.fire('Deleted!',data['message'],'success')
                            window.location.href = data['redirect']
                        }
                        
                    });
                    

                }
            })
        });
    })
   
</script>
{% endblock  %}