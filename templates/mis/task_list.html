{% extends 'base.html' %}
{% load static %}
{% block contents %}
<link href="{% static 'libs/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css'%}" rel="stylesheet" type="text/css">
    <div class="row align-items-center">
        <div class="col-xl-12 mx-auto">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-xl-12">
                            <div class="card">                              
                            <form class="dt_adv_search" method="GET" action="/task-list/" autocomplete="off">
                                <div class="row">
                                    <input type="hidden" value="{{archive}}" name="archive">
                                    <input type="hidden" value="{{month_year}}" name="month_year">
                                    {% if request.user.groups.all.0.id != 1 %}
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                        <label for="mission">Mission:</label>
                                            <select class="form-control" id="mission" name="mission">
                                                <option value="" selected>Select</option> 
                                                {% for mission in mission_objs %}
                                                    <option value="{{mission.id}}">{{mission.name}}</option> 
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>

                                    <div class="col-sm-4">
                                        <div class="form-group">
                                            <label for="project">Project:</label>
                                                <select class="form-control" id="project" name="project">
                                                    <option value="" selected>Select</option> 
                                                    {% for project in project_objs %}
                                                        <option value="{{project.id}}" >{{project.name}}</option> 
                                                    {% endfor %}
                                                </select>
                                        </div>
                                    </div>
                                    {% endif %}
                                    <div class="col-sm-4">
                                        <div class="form-group">
                                        <label for="task_status">Status:</label>
                                        <select class="form-control" id="task_status" name="task_status" >
                                            <option value="" selected>Select</option>
                                            <option value="1">Pending</option>
                                            <option value="2">Submitted for Partner Admin</option>
                                            <option value="3">Submitted for Project In-charge</option>
                                            <option value="4">Approved</option>
                                            <option value="5">Rejected</option>
                                        </select>
                                        </div>
                                    </div>

                                    
                                    <div class="col-sm-4 collapse {{archive}}">
                                        <label>Month-Year :</label>
                                        <div class="position-relative" id="datepickerFrom">
                                            <input type="text" class="form-control" value="{% if month_year %}{{month_year}}{% else %}{{current_month_year}}{% endif %}" name="month_year" id="month_years" data-date-container="#datepickerFrom" data-provide="datepicker"
                                                data-date-format="MM yyyy" data-date-min-view-mode="1" data-date-autoclose="true" data-date-end-date="0d" placeholder="Month & Year">
                                        </div>
                                    </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary mr-1 waves-effect waves-float waves-light" tabindex="5">Search</button>
                                        <span type="reset" class="btn btn-primary mr-1 waves-effect waves-float waves-light" onclick="location.href='/task-list/'" tabindex="7">Reset</span>
                                    </div>                                                
                            </form>
        
                            <div class="table-responsive">
                                {% if not archive %}<p style="float:right;"><b>Periodicity : </b>{{previous_month|date:"F Y"}}</p>{% endif %}
                                <table class="table mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>SL No</th>
                                            <th style="width: 28%;">Mission</th>
                                            <th>Project</th>
                                            <th>Task Month</th>
                                            <th>Task Year</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if object_list %}
                                            {% for task in object_list %}
                                                <tr>
                                                    <td>{{forloop.counter0|add:object_list.start_index}}</td>
                                                    <td>{{task.project.partner_mission_mapping.mission.name}}</td>
                                                    <td>{{task.project.name}}</td>
                                                    <td>{{task.start_date|date:"F"}}</td>
                                                    <td>{{task.start_date|date:"Y"}}</td>
                                                    <td {% if task.task_status  == 1 %}class="badge-soft-danger"
                                                        {% elif task.task_status == 2 %}class="badge-soft-warning"
                                                        {% elif task.task_status == 3 %}class="badge-soft-success"
                                                        {% elif task.task_status == 4 %}style="color:red;"
                                                        {% elif task.task_status == 5 %}style="color:blue;"
                                                        {% endif %} >
                                                    {{task.get_task_status_display}}
                                                    </td>
                                                    {% if task.get_task %}
                                                    <td><b><a href="/mission_edit/{{task.project.partner_mission_mapping.mission.slug}}/{{task.id}}/{{task.get_task.id}}/">
                                                        {% if request.user.groups.all.0.id == 2 %}
                                                            View
                                                        {% elif request.user.groups.all.0.id == 1 %}
                                                            {% if task.task_status == 1 or task.task_status == 5 %}
                                                                Edit
                                                            {% else %}
                                                                View
                                                            {% endif %}
                                                        {% elif request.user.groups.all.0.id ==  4%}
                                                            View
                                                        {% else %}
                                                            View
                                                        {% endif %}
                                                    </a></b></td>
                                                    {% else %}
                                                        
                                                            <td><b><a href="/{{task.project.partner_mission_mapping.mission.slug}}/monthly-report/{{task.id}}/">{% if request.user.groups.all.0.id == 1 %}Add{% else %}View{% endif %}</a></b></td>
                                                    {% endif %}
                                                </tr>
                                            {% endfor %}  
                                        {% else %}
                                            <td colspan="7" class="text-primary">No records found</td>
                                        {% endif %} 
                                        </tbody>
                                </table><br>
                                {% if object_list %}
                                <nav aria-label="...">
                                    {% if object_list.has_other_pages %}
                                    <ul class="pagination justify-content-end ">
                                        {% if object_list.has_previous %}
                                        <li class="paginate_button page-item"><a class="page-link" href="?page={{ 1 }}&archive={{archive}}&month_year={{month_year}}&year={{year}}&month={{month}}&project={{project}}&mission={{mission}}&task_status={{task_status}}">First</a></li>
                                        {% comment %} <li class="paginate_button page-item"><a class="page-link" href="?page={{ object_list.previous_page_number }}">Previous</a></li> {% endcomment %}
                                        {% else %}
                                        <li class="paginate_button page-item disabled"><span class="page-link">First</span></li>
                                            {% comment %} <li class="paginate_button page-item disabled"><span class="page-link">Previous</span></li> {% endcomment %}
                                        {% endif %}
                                        {% for i in display_page_range %}
                                            {% if object_list.number == i %}
                                            <li class="page-item active"><span class="page-link">{{ i }} <span class="sr-only">(current)</span></span></li>
                                            {% else %}
                                            <li class="paginate_button paginate_button page-item"><a class="page-link" href="?page={{ i }}&archive={{archive}}&month_year={{month_year}}&year={{year}}&month={{month}}&project={{project}}&mission={{mission}}&task_status={{task_status}}">{{ i }}</a></li>
                                            {% endif %}
                                        {% endfor %}
                                        {% if object_list.has_next %}
                                            {% comment %} <li class="paginate_button page-item"><a class="page-link" href="?page={{ object_list.next_page_number }}&archive={{archive}}&month_year={{month_year}}&year={{year}}&month={{month}}&project={{project}}&mission={{mission}}&task_status={{task_status}}">Next</a></li> {% endcomment %}
                                            <li class="paginate_button page-item"><a class="page-link" href="?page={{ object_list.paginator.num_pages }}&archive={{archive}}&month_year={{month_year}}&year={{year}}&month={{month}}&project={{project}}&mission={{mission}}&task_status={{task_status}}">Last</a></li>
                                        {% else %}
                                            {% comment %} <li class="paginate_button page-item disabled"><span class="page-link">Next</span></li> {% endcomment %}
                                            <li class="paginate_button page-item disabled"><span class="page-link">Last</span></li>
                                        {% endif %}
                                        </ul>
                                    {% endif %}
                                </nav>
                                {% endif %}
                            </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!-- end row -->
<script src="{% static 'libs/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js'%}"></script>
<script>     
var months = '{{month}}'
if(months != 'None'){
    $('#month').val(months)
}

var task_status = '{{task_status}}'
if(task_status != 'None'){
    $('#task_status').val(task_status)
}

var years = '{{year}}'
if(years != 'None'){
    $('#year').val(years)
}

var missions = '{{mission}}'
if(missions != 'None'){
    $('#mission').val(missions)
}

var projects = '{{project}}'
if(projects != 'None'){
    $('#project').val(projects)
}
</script>
</script>

<style>
    .select2-container .select2-selection {
        min-height: 55px
    }
    .select2-container .select2-selection--single .select2-selection__placeholder:after {
        content: " *";
        color: red;
    }
</style>

<script>
    $('#mission').change(function(){
        $.ajax({
            url : "/ajax-project/",
            type:'POST',
            data:{
                mission_id:$(this).val()
            }, 
            dataType: 'json',
            success: function(response) {
            stateOptions = "<option value='' selected>Select</option>";
            $.each(response, function(key, row){
                    stateOptions += '<option value="'+row.id+'">'+row.name+'</option>';
            });
            $('#project').html(stateOptions);
            }
        });
    });
</script>
<script>
    $(document).ready(function() {
        $('#month_years').datepicker({
            endDate: '0d'
        });
    });
</script>
{% endblock %}

