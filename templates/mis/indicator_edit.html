{% extends 'base.html' %}
{% load configuration_tags   %}
{% load static %}
{% block contents %}

<div class="row">
    <div class="col-xl-12 mx-auto">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% if mission_respose_obj.task.task_status%}
                        <p  class="text-dark"><b>Status : </b>{{mission_respose_obj.task.get_task_status_display}}</p>
                        {% endif %}
                        <h5 ><b class="card-title">Project : </b><span style="font-size: 14px;">{{mission_respose_obj.task.project.name}}</span></h5>
                        <h5><b class="card-title">Dist. & State : </b><span style="font-size: 14px;">{{mission_respose_obj.task.project.district.name}}, {{mission_respose_obj.task.project.district.state.name}}</span></h5>
                        <h5><b class="card-title">Project funded by : </b><span style="font-size: 14px;"> {{mission_respose_obj.task.project.get_project_donor_mapping}}</span></h5>
                    </div>

                    <div class="col-md-6">
                        <h5 id="right_side"><b class="card-title">Partner: </b><span style="font-size: 14px;">{{mission_respose_obj.task.project.partner_mission_mapping.partner.name}}, {{mission_respose_obj.task.project.district.name}}, {{mission_respose_obj.task.project.district.state.name}}</span> </h5>
                        <h5 id="right_side"><b class="card-title">Month: </b><span style="font-size: 14px;">{{mission_respose_obj.task.start_date|date:"F Y"}}</span> </h5>

                        {% disply_financial_year mission_respose_obj.task.start_date as financial_year %} 
                        <h5 id="right_side" > <b class="card-title">Financial year: </b></b><span style="font-size: 14px;">{{financial_year}}</span></h5>
                    </div>
                </div>

                <form method='POST' class="" enctype="multipart/form-data" novalidate>
                    {% if slug == 'mission-jyot' %}
                    <label for="working_day" class="card-title">Number of days the Vision Centre was open: </label>
                    <input type="number" id="working_day" name="working_day" style="width: 50px;">
                    {% endif %}
                {%  if 'Partner Data Entry Operator' == user_role and mission_respose_obj.task.task_status == 1 or mission_respose_obj.task.task_status == 4 %}
                <input type='button' style="float: right;" id='download_button' class="btn btn-primary w-md" value='Submit for Approval' onclick="Confirm('{{mission_respose_obj.task.id}}',2,'Submit for Approval')">
                {% endif %}

                {% csrf_token %}
                    {% if programe_category %}
                    <p class="text-dark text-center text-uppercase"><b><br>Programme Data</b></p>
                    {% for data in programe_category %}
                        <div class="table-responsive">
                            <h5 class="text-dark card-title"> <b>{{data.name}}</b></h5>
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr><th>Indicator</th>
                                        <th>Indicator Type</th> 
                                        <th>Target</th>
                                        <th>Total </th>
                                        <th>Adult Male</th>
                                        <th>Adult Female</th>
                                        <th>Adult Transgender</th>
                                        <th>Child Male</th>
                                        <th>Child Female</th>
                                        <th>Child Transgender</th>
                                    </tr>
                                </thead>
                                    {% for sub_category in data.sub_category %}
                                    <tbody>
                                        <td>{{sub_category.name}}</td> 
                                        <td>{{sub_category.get_indicator_type_display}} </td> 
                                        
                                        {% disply_indicator_target_values mission_respose_obj.task.id sub_category.id as target_values %}  
                                        <td>{{target_values}} </td> 
                                        <td>     
                                            {% disply_indicator_values mission_respose_obj.id sub_category.id  'total_' as total %}                                  
                                            <input type="number" id="txtresult"  name="total_{{sub_category.id}}" value="{{total}}" class="form-control" maxlength="1" readonly> 
                                            <div class="invalid-feedback">Please enter the Total value</div>
                                        </td>
                                        <td>
                                            {% disply_indicator_values mission_respose_obj.id sub_category.id  'adult_male_' as adult_male %}  
                                            <input type="number" id="Text1"  name="adult_male_{{sub_category.id}}" value="{{adult_male}}" class="form-control" maxlength="2" onkeypress="return add_number(event)" >
                                        </td>
                                        <td>
                                            {% disply_indicator_values mission_respose_obj.id sub_category.id  'adult_female_' as adult_female %} 
                                            <input type="number" id="Text2"  name="adult_female_{{sub_category.id}}" value="{{adult_female}}" class="form-control" maxlength="3" onkeypress="return add_number(event)">
                                        </td>
                                        <td>
                                            {% disply_indicator_values mission_respose_obj.id sub_category.id  'adult_transgender_' as adult_transgender %} 
                                            <input type="number" id="Text3" name="adult_transgender_{{sub_category.id}}" value="{{adult_transgender}}" class="form-control" maxlength="4" onkeypress="return add_number(event)">
                                        </td>
                                        <td>
                                            {% disply_indicator_values mission_respose_obj.id sub_category.id  'child_male_' as child_male %}
                                            <input type="number" id="Text4"  name="child_male_{{sub_category.id}}" value="{{child_male}}" class="form-control" maxlength="5" onkeypress="return add_number(event)">
                                        </td>
                                        <td>
                                            {% disply_indicator_values mission_respose_obj.id sub_category.id  'child_female_' as child_female %}
                                            <input type="number" id="Text5"  name="child_female_{{sub_category.id}}" value="{{child_female}}" class="form-control" maxlength="6" onkeypress="return add_number(event)">
                                        </td>
                                        <td>
                                            {% disply_indicator_values mission_respose_obj.id sub_category.id  'child_transgender_' as child_transgender %}
                                            <input type="number" id="Text6" name="child_transgender_{{sub_category.id}}" value="{{child_transgender}}" class="form-control" maxlength="7" onkeypress="return add_number(event)">
                                        </td>
                                    </tbody>    
                                    {% endfor %} 
                            </table><br>
                            </div>
                        {% endfor %} 
                    {% endif %}

                    {% if finance_category %}
                    <p class="text-dark text-center text-uppercase"><b><br>Finance Data</b></p>
                    {% for fin_data in finance_category %}
                    <div class="table-responsive">
                            <h5 class="text-dark card-title"> {{fin_data.name}} </h5>
                            <table class="table table-hover" id="hospital_report">
                                <thead class="table-light">
                                    <tr>
                                        <th>Particulars</th>
                                        {% if fin_data.label_configuration == 2 %}
                                        <th>Approved Budget</th>
                                        <th>Grants Received</th>
                                        <th>Expenses</th>
                                        {% else %}
                                        <th>Amount</th>
                                        {% endif %}
                                        <th>Comment</th>
                                    </tr>
                                </thead>
                                {% for sub_category in fin_data.sub_category %}
                                <tbody>
                                    <td>{{sub_category.name}}</td> 
                                    
                                    {% disply_indicator_target_values mission_respose_obj.task.id sub_category.id as target_values %}  
                                    <td>{{target_values}}</td> 

                                    {% if fin_data.label_configuration == 2 %}
                                    <td>
                                        {% disply_indicator_values mission_respose_obj.id sub_category.id  'actuals_with_grants_received_' as actuals_with_grants_received %}                                  
                                        <input type="number"  name="actuals_with_grants_received_{{sub_category.id}}" value="{{actuals_with_grants_received}}" class="form-control" maxlength="5" {% if sub_category.indicator_type == 3 %} readonly {% endif %}>
                                    </td> 
                                    <td>
                                        {% disply_indicator_values mission_respose_obj.id sub_category.id  'actuals_' as actuals %}                                  
                                        <input type="number"  name="actuals_{{sub_category.id}}" value="{{actuals}}" class="form-control" maxlength="5" >
                                    </td> 
                                    {% endif %}
                                   
                                    <td>
                                        {% disply_indicator_values mission_respose_obj.id sub_category.id  'comment_' as comment %}                                  
                                        <input type="text"  name="comment_{{sub_category.id}}" value="{% if comment %}{{comment}}{% endif %}" class="form-control">
                                    </td> 
                                </tbody>   
                                {% endfor %} 
                            </table>
                        </div>
                        {% endfor %} 
                    {% endif %}
                    
                    <label for="project_reference_file">Project Reference File : </label>
                    <input type="file" name="project_reference_file">

                    <div class="modal-footer">
                            {%  if 'Partner Data Entry Operator' == user_role %}
                                {% if mission_respose_obj.task.task_status == 1 or mission_respose_obj.task.task_status == 4 %}
                                <button type="submit" class="btn btn-primary  ml-2">Save</button>
                                <button type="reset" onclick="location.href='/task-list/'" class="btn btn-secondary waves-effect">Cancel</button>
                                {% endif %}
                            {%  elif 'Partner Admin' == user_role %}
                                {% if mission_respose_obj.task.task_status == 2 %}
                                <button type="button" value="{{task_id}}" class="confirm_btn btn btn-info ml-2" onclick="Confirm('{{mission_respose_obj.task.id}}',3,'Approve')">Approved</button>
                                <button type="button" value="{{task_id}}" class="confirm_btn btn btn-info ml-2" onclick="Confirm('{{mission_respose_obj.task.id}}',4,'Reject')">Reject</button>
                                <button type="reset" onclick="location.href='/task-list/'" class="btn btn-secondary waves-effect">Cancel</button>
                                {% endif %}
                            {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    #right_side{
        margin-left: 50%
    }
</style>

<script>
    function add_number(e) {
    if (isNumberKey(e)) {
        setTimeout(() => {
        var first_number = document.getElementById("Text1").value !== "" ? parseInt(document.getElementById("Text1").value) : 0;
        var second_number = document.getElementById("Text2").value !== "" ? parseInt(document.getElementById("Text2").value) : 0;
        var three_number = document.getElementById("Text3").value !== "" ? parseInt(document.getElementById("Text3").value) : 0;
        var four_number = document.getElementById("Text4").value !== "" ? parseInt(document.getElementById("Text4").value) : 0;
        var five_number = document.getElementById("Text5").value !== "" ? parseInt(document.getElementById("Text5").value) : 0;
        var six_number = document.getElementById("Text6").value !== "" ? parseInt(document.getElementById("Text6").value) : 0;

        var result = first_number + second_number+ three_number + four_number+five_number+six_number;
        document.getElementById("txtresult").value = result;
        }, 50)
        return true;
    } else {
        return false;
    }
    }

    function isNumberKey(evt) {
    var charCode = (evt.which) ? evt.which : event.keyCode
    if (charCode > 31 && (charCode < 48 || charCode > 57)) {
        return false;
    }
    return true;
    }
</script>
<script>
    function Confirm(task_id,val,title){
        Swal.fire({
        title: 'Are you sure you want to '+ title +' ?',
        showCancelButton: true,
        confirmButtonText: 'Yes',
        }).then((result) => {
        /* Read more about isConfirmed, isDenied below */
        if (result.isConfirmed){
            $.ajax({
            url: '/ajax-task/'+task_id,
            type:'POST',
            data:{status_val:val}, 
            dataType: 'json',
            success: function(result) {
                window.location.reload();
            } 
        });
        }
    }).then(function(){ window.location.reload(); })
    }
</script>

{% endblock %}