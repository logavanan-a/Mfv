{% extends "base.html" %}
{% load static %}
{% load report_tags %}
{% block contents %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<div class="content">
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
            <div class="card-body">
                <div class="card-header card-header-icon d-flex justify-content-between align-items-center " data-background-color="rose">
                    <div class="d-flex">
                        <i class="p-1 bx bx-paste icon-size-lg"></i>
                        <h4 class="p-1 card-title card-heading-text">{% if widget_obj %} {{widget_obj.title}} {% else %}Home Visit Report {% endif %}</h4>
                    </div>
                    <div class="d-flex" style="gap:5px">
                        <a href="/reports/exportcsv/export-reports/" title="Back">
                            <button class="btn btn-sm btn-danger">
                                <em class="bx bx-left-arrow-circle icon-size-lg"></em>
                            </button>
                        </a>
                        {%if widget_obj.slug != 'benificiary-data' or widget_obj.slug != 'custom-report' %}
                        <a onclick="show_or_hide_filter()">
                            <button class="btn btn-primary btn-just-icon btn-round btn-dribbble btn-sm" style="float:right" rel="tooltip" data-original-title="Filter">
                                <em class="  bx bx-filter icon-size-lg"></em>
                            </button>
                        </a>
                        {% endif %}
                    </div>

                </div>
                <div class="card-content card_section">


                    <div class="text_width">
                    {% if filters_cond == True %}
                    <form action='.' class="finance-report" id='download_form'>
                    {% if from_to_filters == True %}
                    <div class="col-md-4">
                            <div class="row">
                                <!-- <div class="datetime_picker">
                                    
                                    <input type="text" name="from_date" title="Select From Date" class = "datepicker form-control" id="id_start_date" value="{% if filter_from_date %}{{filter_from_date}}{% endif %}" placeholder="From Date " autocomplete="off">
                                </div>
                                <div class="datetime_picker">
                                   <input type="text" name="to_date" title="Select To Date" class = "datepicker form-control" id="id_end_date" placeholder="To Date" value="{% if filter_to_date %}{{filter_to_date}}{% endif %}" onclick="myFunction()" autocomplete="off">
                                </div> -->


                                <button id='#load_form' class="btn btn-rose btn-sm" style="float: left; top: 12px;"> Go </button>
                                <a href="/reports/{{report_slug}}/" class="btn btn-sm btn_load"> Reset </a>

                            </div>

                    {% endif %}

                        <div style="float:left; width:100%">
                           <input type="hidden" name='report_slug' value='{{report_slug}}'>
                        </div>

                    </div>
                    </form>


                     {% endif %}
                     
                        <div class='col-md-8'  style=" float:right;  width: auto;margin-top: 12px; ">
                           
                       
                        <!-- {%if report_slug != 'export-reports'%}
                        <a href="/reports/{{report_slug}}/?export=true{% if report_slug %}&report_slug={{report_slug}}{%endif%}" >
                            <button class="btn btn-sm btn-info" style="float: right;">Export <div class="ripple-container"></div></button>
                        </a>
                        {%endif%} -->
                    </div>
                    

                    <div class='reset_cls'>
                        </div>
                    </div>
                    <div class="col-md-4" style="padding-top: 12px;">
                        {% if error %}<p>{{error}}</p>{% endif %}
                            {% if not total_no_of_records == -1 %}
                                <p style="padding-left: 0%;">Total No. Of Records: {% if total_no_of_records %}{{total_no_of_records}}
                                    {% else %}0{% endif %}
                                </p>
                            {% endif %}
                        </div>
                        <div class="material-datatables new_datatablefilter table-responsive width_section" >
                            <form type="get" action="." style="margin: 0">
                                {%if widget_obj.slug != 'benificiary-data' and widget_obj.slug != 'custom-report' %}
                                <!-- date filetr start-->
                                <!-- <div class="col-lg-4">
                                    <div class="datetime_picker">
                                        <input type="text" name="from_date" title="Select From Date" class = "datepicker form-control" id="id_start_date" value="{% if filter_from_date %}{{filter_from_date}}{% endif %}" placeholder="From Date" autocomplete="off">
                                    </div>
                                    <div class="datetime_picker">
                                       <input type="text" name="to_date" title="Select To Date" class = "datepicker form-control" id="id_end_date" placeholder="To Date" value="{% if filter_to_date %}{{filter_to_date}}{% endif %}" onclick="myFunction()" autocomplete="off">
                                    </div>
                                </div> -->
                                    <div class="col-md-6 " style="display: none;" id = 'search_button'>
                                        <div class="col-md-6 p-1" >
                                            <input class="form-control col-md-6" data-width="50%" id="search_box" type="text" name="search_box"  placeholder="Search..." >
                                        </div>
                                        <div class="p-1">
                                            <!-- <button id="search_submit" type="submit" onclick="checkLength()" >Submit</button> -->
                                            <button class="btn btn-primary btn-sm" id="search_submit" type="submit" >Search</button>
                                            <a href="/reports/exportcsv/{{report_slug}}/" class="btn btn-danger btn-sm btn_load"> Reset </a>
                                            
                                        </div>

                                    </div>

                                    <div class="d-flex flex-wrap">

                                        <!-- <div class="p-1 col-12 col-md-6">
                                            <spen>Activity Date(From) :</spen>
                                            <input type="date" name="from_date"  onfocus="this.max=new Date().toISOString().split('T')[0]" title="Select From Date" class = "form-control" id="id_start_date" value="{% if from_date_filter %}{{from_date_filter}}{% endif %}" placeholder="From Date" autocomplete="off">
                                        </div>
                                        
                                        <div class="p-1 col-12 col-md-6">
                                            <spen>Activity Date(To) :</spen>
                                           <input type="date" name="to_date"  onfocus="this.max=new Date().toISOString().split('T')[0]"  title="Select To Date" class = "form-control" id="id_end_date" placeholder="To Date" value="{% if to_date_filter %}{{to_date_filter}}{% endif %}" onclick="myFunction()" autocomplete="off">
                                        </div> -->
                                    </div>

                                <!-- date filetr end -->

                                <!-- flatpicker date -->

                                <!-- flatpicker date end -->
                                <!-- Theme filter start-->
                                 <!-- <div class="col-md-6" id="div_{{level.code}}">
                                    <div class="">
                                        <div class="form-group label-floating select_group">
                                            <spen>Themes</spen>
                                            <select class="selectpicker" data-style="select-with-transition" name="theme" id="id_theme" data-live-search="true" multiple>
                                                <option value="">Select Themes</option>
                                                {% for theme in theme_list %}
                                                    <option value="{{project.id}}">{{theme.name}}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div> -->
                                
                                <!--theme filter end-->
                                <!-- project filter start-->
                                
                                <!-- <div class="col-md-6" id="div_{{level.code}}">
                                    <div class="">
                                        <div class="form-group label-floating select_group">
                                            <spen>Projects</spen>
                                            <select class="selectpicker" data-style="select-with-transition" name="Project" id="id_project" data-live-search="true" multiple="multiple" >
                                                <option value="">Select Projects</option>
                                                {% for project in projectlist %}
                                                    <option value="{{project.id}}" {% if project.id in project_list_id  %}selected{% endif %}>{{project.id}}_{{project.name}}</option>
                                                {% endfor %}
                                            </select>
                                        </div> 
                                    </div>
                                </div> -->
                                
                                <!-- project filter end-->
                                
                                
                                

                                <!-- location  filter start  -->
                                {% if levels_to_filter %}
                                    <div class="filter_class d-flex flex-wrap">
                                        <div class="p-1 col-12 col-md-6" id="div_{{level.code}}">
                                            <div class="">
                                                <div class="form-group label-floating select_group">
                                                    <span>Projects<span class="required">*</span> 
                                                  </span>
                                                    <select class="selectpicker select2 " data-width="100%" data-style="select-with-transition" name="Project" id="id_project" data-live-search="true" multiple="multiple">
                                                        <option value="" disabled >Select Projects</option>
                                                        {% for project in projectlist %}
                                                            <option value="{{project.id}}" {% if project.id|slugify in project_list_id  %}selected{% endif %}>{{project.name}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div> 
                                            </div>
                                        </div>
                                        {% comment %} <div class="p-1 col-12 col-md-6" id="div_{{level.code}}">
                                            <div class="">
                                                <div class="form-group label-floating select_group">
                                                    <spen>Themes</spen>
                                                    <select class="selectpicker select2" data-width="100%" data-style="select-with-transition" name="theme" id="id_theme" data-live-search="true" multiple>
                                                        <option value="" disabled >Select Themes</option>
                                                        {% for theme in theme_list %}
                                                            <option value="{{theme.id}}" {% if theme.id|slugify in theme_list_str  %}selected{% endif %}>{{theme.name}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div> {% endcomment %}
                                        <form class="d-flex flex-wrap" action="." method='GET' id="survey">
                                        {% for level in levels_to_filter %}
                                            <div class="p-1 col-12 col-md-6" id="div_{{level.code}}">
                                                <div class="">
                                                    <div class="form-group label-floating select_group">
                                                        <spen>{{level.name}}</spen>
                                                        <select class="selectpicker select2" data-width="100%"   data-style="select-with-transition" name="{{level.name}}" id="id_{{level.code}}" data-live-search="true" next-level="{% if level.get_next_level %}{{level.get_next_level.code}}{% endif %}" {% if first_level_options|length == -1 and forloop.counter == 1  %}disabled{% endif %} level-to-hide="{{level.next_levels|safe}}" multiple>
                                                            {% for boundary in level_options|get_item:level.name %}
                                                                <option value="{{boundary.id}}" {% if boundary.id|slugify in location_values|get_item:level.name %}selected{% endif %}>{{boundary.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                {% endif %}
                                        <!--location  filter end  -->

                                
                            {%endif%}
                                
                                        <div class="col-6 col-md-6 mt-md-4">
                                            <!-- <div class="d-flex justify-content-between" >
                                                {%if widget_obj.slug not in "'custom-report','benificiary-data'" %}
                                                <div class="p d-flex" style="position: relative; left:10px; top: 8.5px !important; gap:10px"> -->
                                                    <!-- <input  id="search_box" type="text" name="search_box"  placeholder="Search..." > -->
                                                    <!-- <button id="search_submit" type="submit" onclick="checkLength()" >Submit</button> -->
                                                    <!-- <button id="search_submit" class="btn btn-primary btn-sm " type="submit" >Submit</button>
                                                    <a href="/reports/exportcsv/{{report_slug}}/" class="btn btn-danger btn-sm btn_load"> Reset </a>
        
                                                </div>
                                                {%endif%} -->
                                                
                                            </div>
                                        </div>
                                    
                            </form>
                            <table id="datatables" class="table table-striped" cellspacing="0">
                            <thead class="table-light" >
                                <th  >SI No</th>
                            {% for loc in qlist %}
                                <th  >{{loc}}</th>
                            {% endfor %}
                            </thead>
                            <tbody style="font-size: 0.8125rem;">
                            {% if object_list %}
                                {% for i in object_list %}
                                <tr>
                                    <td>{{forloop.counter0|add:start_index}}</td>
                                    {% for k in i %}
                                        <td>{{k}}</td>
                                    {% endfor %}
                                       
                                    {%if report_slug in "'export-reports','benificiary-data'" and i.2 != '-' %}<td>
                                    <a href="#" onclick="export_csv('{{i.0}}')">Download</a>
                    <!-- <a href="javascript:onclickFunction('id')">Download</a>     -->
                                    </td>
                                    {% elif report_slug == 'custom-report' and i.2 != '-' %}<td>
                                        <a href="/reports/custom-report-csv/{{i.0}}/">Download</a>
                        <!-- <a href="javascript:onclickFunction('id')">Download</a>     -->
                                        </td>
                                    {%else%}
                                    <td>&nbsp;</td>
                                    {%endif%}
                                {% endfor %}
                                </tr>
                            {% else %}
                                    <td class="text-primary">No records found</td>
                            {% endif %}
                            </tbody>
                        </table>
                      
                    </div>
                        {% if object_list %}
                        {% include 'reports/custom_pagination.html' %}
                        <!-- {% include 'survey_forms/pagination.html' %} -->
                        {% endif %}
                </div>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_javascript%}
<script type="text/javascript" src="/static/assets/js/jquery.datepick.js"> </script>
<!--<script src="/static/assets/js/jquery-3.2.1.min.js" type="text/javascript"></script>-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
    function show_or_hide_filter(){
        console.log('hereeeeeeeeeeeeeeeeeee')
        if (document.getElementById("search_button").style.display == 'none'){
            document.getElementById("search_button").style.display = 'inline';
              
        }
        else{
            document.getElementById("search_button").style.display = 'none';
        }
      };

</script>
<script>
    function export_csv(survey_id) {
        var data = {'project_id[]':$("#id_project").val(),'survey_id':survey_id,'district[]':$('#id_2').val(),'block[]':$('#id_3').val(),'grampanchayat[]':$('#id_4').val(),'village[]':$('#id_5').val(),'user_id': '{{request.user.id}}','start_date':$('#id_start_date').val(),'end_date':$('#id_end_date').val()}
        const queryString = $.param(data);
        window.location.href = '/export_data/file-download/?'+queryString
    }
  $( function() {
    $(".datepicker").datepicker({
            currentText : "Now",
            maxDate : '0',
            dateFormat:"yy-mm-dd",
            onSelect: function (selected) {
                var dt = new Date(selected);
                dt.setDate(dt.getDate() + 0);
                $("#ed").datepicker("option", "minDate", dt);
            }
        });

        $(".datepicker").datepicker({
            currentText: "Now",
            maxDate : '0',
            dateFormat:"yy-mm-dd",
            onSelect: function (selected) {
                var dt = new Date(selected);
                dt.setDate(dt.getDate() - 0);
                $("#sd").datepicker("option", "maxDate", dt);
            }
        });
  });

    function myFunction() {
    var input, filter, ul, li, a, i, txtValue;
    input = document.getElementById("myInput");
    filter = input.value.toUpperCase();
    ul = document.getElementById("myUL");
    li = ul.getElementsByTagName("li");
    debugger;
    for (i = 0;i < li.length; i++) {
        a = li[i].getElementsByTagName("a")[0];
        txtValue = a.textContent || a.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = "";
        } else {
            li[i].style.display = "none";
        }
    }
}

function checkLength(){
    var textbox = document.getElementById("search_box");
    if(textbox.value.length <= 2 ){
        alert("Text is short, Minimum 3 Charaters required")
    }
}

</script>

<!-- location filter scripts -->
<script>
    $(document).ready(function() {
        $("#id_project").on('change', function(){
            $.ajax({
               type:"POST",
               url:"/configuration/boundary/search/state",
               dataType: "json",
               data: {'project_id[]':$("#id_project").val(),'user_id': '{{request.user.id}}'},
               success: function(d) {
                   if (d.data) {    
                        var res = d.data;
                        $('#id_2').find('option').remove().end();
                        for (i=0;i<res.length;i++) {
                            if(Number('{{request.GET.district}}') == res[i].id){
                                $('<option>', {value : res[i].id}).html(res[i].name).appendTo('#id_2' ).attr('selected', 'selected')
                            }
                            else{
                                $('<option>', {value : res[i].id }).html(res[i].name).appendTo('#id_2');
                            }
                        }
                        $('.selectpicker').selectpicker('refresh')
                    }
                }
            });
        });
        });
    </script>
    <script>
    $(document).ready(function() {
        $("#id_state").on('change', function(){
            $.ajax({
               type:"POST",
               url:"/configuration/boundary/search/",
               dataType: "json",
               data: {'parent_id':$("#id_1").val(), 'next_level_id': '2', 'survey_id': '{{survey.id}}', 'user_id': '{{request.user.id}}', 'project_id':$("#id_project").val(), 'field_name': ''},
               success: function(d) {
                   if (d.data) {    
                        var res = d.data;
                        $('#id_district').find('option').remove().end();
                        for (i=0;i<res.length;i++) {
                            if(Number('{{request.GET.district}}') == res[i].id){
                                $('<option>', {value : res[i].id}).html(res[i].name).appendTo('#id_district').attr('selected', 'selected')
                        }
                        else{
                            $('<option>', {value : res[i].id }).html(res[i].name).appendTo('#id_district');
                            }
                        }
                        $('.selectpicker').selectpicker('refresh')
                    }
                }
            });
        });
        });
    </script>
    <script>
        $(document).ready(function() {
            $("#id_district").on('change', function(){
                $.ajax({
                   type:"POST",
                   url:"/configuration/boundary/search/",
                   dataType: "json",
                   data: {'parent_id':$("#id_district").val(), 'next_level_id': '3', 'survey_id': '{{survey.id}}', 'user_id': '{{request.user.id}}', 'project_id':$("#id_project").val(), 'field_name': ''},
                   success: function(d) {
                       if (d.data) {    
                            var res = d.data;
                            $('#id_district').find('option').remove().end();
                            for (i=0;i<res.length;i++) {
                                if(Number('{{request.GET.block}}') == res[i].id){
                                    $('<option>', {value : res[i].id}).html(res[i].name).appendTo('#id_block').attr('selected', 'selected')
                            }
                            else{
                                $('<option>', {value : res[i].id }).html(res[i].name).appendTo('#id_block');
                                }
                            }
                            $('.selectpicker').selectpicker('refresh')
                        }
                    }
                });
            });
            });
        </script>
    <script>
    $(document).ready(function() {
        $("#id_block").on('change', function(){
            $.ajax({
               type:"POST",
               url:"c",
               dataType: "json",
               data: {'parent_id':$("#id_block").val(), 'next_level_id': '4', 'survey_id': '{{survey.id}}', 'user_id': '{{request.user.id}}', 'project_id': $("#id_project").val(), 'field_name': ''},
               success: function(d) {
                   if (d.data) {
                        var res = d.data;
                        $('#id_block').find('option').remove().end();
                        for (i=0;i<res.length;i++) {
                            if(Number('{{request.GET.gp}}') == res[i].id){
                                $('<option>', {value : res[i].id}).html(res[i].name).appendTo('#id_gp').attr('selected', 'selected')
                        }
                        else{
                            $('<option>', {value : res[i].id }).html(res[i].name).appendTo('#id_gp');
                            }
                        }
                        $('.selectpicker').selectpicker('refresh')
                    }
                }
            });
        });
        });
    </script>
    <script>
    $(document).ready(function() {
        $("#id_gp").on('change', function(){
            $.ajax({
               type:"POST",
               url:"/configuration/boundary/search/",
               dataType: "json",
               data: {'parent_id':$("#id_gp").val(), 'next_level_id': '5', 'survey_id': '{{survey.id}}', 'user_id': '{{request.user.id}}', 'project_id': $("#id_project").val(), 'field_name': ''},
               success: function(d) {
                   if (d.data) {
                        var res = d.data;
                        $('#id_sector').find('option').remove().end();
                        for (i=0;i<res.length;i++) {
                            if(Number('{{request.GET.village}}') == res[i].id){
                                $('<option>', {value : res[i].id}).html(res[i].name).appendTo('#id_village').attr('selected', 'selected')
                        }
                        else{
                            $('<option>', {value : res[i].id }).html(res[i].name).appendTo('#id_village');
                            }
                        }
                        $('.selectpicker').selectpicker('refresh')
                    }
                }
            });
        });
        });
    </script>
    
    
    
    <script>
    
        $(document).ready(function() {
    
            $(".selectpicker").on('change', function(){
                var id=$.makeArray($(this).val());
                var next_level_id = $(this).attr('next-level');
                console.log(next_level_id,'next_level_id')
                display_master_data(id, next_level_id, '')
                var next_levels = $(this).attr('level-to-hide') || '';
                var str_array = next_levels.split(',');
                for ( var i = 0, l = str_array.length; i < l; i++ ) {
                    $('#id_' + str_array[ i ]).val('')
                    $('#id_' + str_array[ i ]).find('option').not(':first').remove()
                }
                $('.selectpicker').selectpicker('refresh')
            });
        });
        function display_master_data(id, next_level_id, sometext=''){

            $.ajax({
               type:"POST",
               url:"/configuration/boundary/search/",
               dataType: "json",
               data: {'parent_id':id, 'next_level_id': next_level_id,  'user_id': '{{request.user.id}}','project_id':$("#id_project").val()},
               success: function(d) {
                   if (d.data) {
                        var res = d.data;
                        $('#id_'+ d.next_level_id).find('option').remove().end();
                        $('<option>', {value : "" ,  disabled: true }).html("Select " + d.display_name).appendTo('#id_'+ d.next_level_id);
                        for (i=0;i<res.length;i++) {
                            $('<option>', {value : res[i].id }).html(res[i].name).appendTo('#id_'+ d.next_level_id);
                             if (sometext){
                                console.log(sometext, id, res[i].id)
                                $('#id_'+d.next_level_id).val(sometext)
                            }
                            
                        }
                        $('.selectpicker').selectpicker('refresh')
                    }
                }
            });
        }
    </script>

    <!--  -->
    <script>
        function myFunction(status) {
            start_date = $("#id_start_date").val();
            end_date = $("#id_end_date").val();
            project = $("#id_project").val();
            vertical = $("#id_vertical").val();
            attribute = $("#id_attribute").val();
            if (project == ""  ){
                return false;
                
            }
            var input = $("<input>")
                       .attr("type", "hidden")
                       .attr("name", "download").val(status);
        $('#download_form').append($(input));
                $('#download_form').submit()
        }
    </script>

    
<script>
    function location1_list(project_id){
       // $('#id_project').on('change',function(){
            //var project_id = $('#id_project').val();
            if(project_id > 0)
            debugger;
            {
            $.ajax({
                url:'/manage/report/project/location/list/',
                type:'GET',
                data:{'project_id':project_id},
                dataType:"json",
                success:function(datas){
                var act = $('#id_parent_location').val();
                var act1 = $('#id_vertical').val();
                var act2 = $('#id_attribute').val();
                    $('#id_parent_location option').remove();
                    $('#id_vertical option').remove();
                    $('#id_attribute option').remove();
                    $('#id_location option').remove();
                    if(datas.msg){
                    $('.error_msg').append('<p>'+datas.msg +'</p>')
                    $('.error_msg').show();
                 }
                     if (datas.location_list){
                        location_list = datas.location_list
                        //$('<option value = 0 disabled="disabled">NOTHING SELECTED </option>').appendTo('#id_district_location');
                       for (var i=0;i<location_list.length;i++){
                       
                        $('<option value="'+ location_list[i].id+'">' + location_list[i].name + '</option>').appendTo('#id_parent_location');
                        }
                     $('.selectpicker').selectpicker('refresh')
                 }
                 
                  if (datas.vertical_list){
                        vertical_list = datas.vertical_list
                        //$('<option value = 0 disabled="disabled">NOTHING SELECTED </option>').appendTo('#id_vertical');
                       for (var i=0;i<vertical_list.length;i++){
                       
                        $('<option value="'+ vertical_list[i].id+'">' + vertical_list[i].name + '</option>').appendTo('#id_vertical');
                        }
                     $('.selectpicker').selectpicker('refresh')
                 }
                 
                  if (datas.attribute_list){
                        attribute_list = datas.attribute_list
                        //$('<option value = 0 disabled="disabled">NOTHING SELECTED </option>').appendTo('#id_attribute');
                       for (var i=0;i<attribute_list.length;i++){
                        $('<option value="'+ attribute_list[i].qid+'">' + attribute_list[i].q_name + '</option>').appendTo('#id_attribute');
                        }
                     $('.selectpicker').selectpicker('refresh')
                 }
                 
                 
                },
                error : function(){}
            });
    
    
        }
        }
        </script>

        {% comment %} <script>
   
            $(".no_futdate").flatpickr({
                dateFormat: "d-m-Y",
                maxDate: "today",
                allowInput: 'true',
                // allowInvalidPreload: 'true',
                disableMobile: "true",
            });
        </script> {% endcomment %}


{% endblock %}