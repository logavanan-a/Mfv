{% extends "base.html" %}
{% load static %}
{% load report_tags %}
{% block contents %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<div class="contents">
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="card">
            <div class="card-body">
                <div class="card-header card-header-icon d-flex justify-content-between align-items-center " data-background-color="rose">
                    <div class="d-flex">
                        <i class="p-1 bx bx-paste icon-size-lg"></i>
                        <h4 class="p-1 card-title card-heading-text">{% if widget_obj %} {{widget_obj.title}} {% else %}Home Visit Report {% endif %}</h4>
                    </div>
                    <div class="d-flex" style="gap:5px">
                        <a href="/reports/exportcsv/export-reports/" title="Back">
                            <button class="btn btn-sm btn-danger">
                                <em class="bx bx-left-arrow-circle icon-size-lg"></em>
                            </button>
                        </a>
                        {%if widget_obj.slug != 'benificiary-data' or widget_obj.slug != 'custom-report' %}
                        <a onclick="show_or_hide_filter()">
                            <button class="btn btn-primary btn-just-icon btn-round btn-dribbble btn-sm" style="float:right" rel="tooltip" data-original-title="Filter">
                                <em class="  bx bx-filter icon-size-lg"></em>
                            </button>
                        </a>
                        {% endif %}
                    </div>

                </div>
                <div class="card-content card_section">


                    <div class="text_width">
                    {% if filters_cond == True %}
                    <form action='.' class="finance-report" id='download_form'>
                    {% if from_to_filters == True %}
                    <div class="col-md-4">
                            <div class="row">
                                <!-- <div class="datetime_picker">
                                    
                                    <input type="text" name="from_date" title="Select From Date" class = "datepicker form-control" id="id_start_date" value="{% if filter_from_date %}{{filter_from_date}}{% endif %}" placeholder="From Date " autocomplete="off">
                                </div>
                                <div class="datetime_picker">
                                   <input type="text" name="to_date" title="Select To Date" class = "datepicker form-control" id="id_end_date" placeholder="To Date" value="{% if filter_to_date %}{{filter_to_date}}{% endif %}" onclick="myFunction()" autocomplete="off">
                                </div> -->


                                <button id='#load_form' class="btn btn-rose btn-sm" style="float: left; top: 12px;"> Go </button>
                                <a href="/reports/{{report_slug}}/" class="btn btn-sm btn_load"> Reset </a>

                            </div>

                    {% endif %}

                        <div style="float:left; width:100%">
                           <input type="hidden" name='report_slug' value='{{report_slug}}'>
                        </div>

                    </div>
                    </form>


                     {% endif %}
                     
                        <div class='col-md-8'  style=" float:right;  width: auto;margin-top: 12px; ">
                           
                       
                        <!-- {%if report_slug != 'export-reports'%}
                        <a href="/reports/{{report_slug}}/?export=true{% if report_slug %}&report_slug={{report_slug}}{%endif%}" >
                            <button class="btn btn-sm btn-info" style="float: right;">Export <div class="ripple-container"></div></button>
                        </a>
                        {%endif%} -->
                    </div>
                    

                    <div class='reset_cls'>
                        </div>
                    </div>
                    <div class="col-md-4" style="padding-top: 12px;">
                        {% if error %}<p>{{error}}</p>{% endif %}
                            {% if not total_no_of_records == -1 %}
                                <p style="padding-left: 0%;">Total No. Of Records: {% if total_no_of_records %}{{total_no_of_records}}
                                    {% else %}0{% endif %}
                                </p>
                            {% endif %}
                        </div>
                        <div class="material-datatables new_datatablefilter table-responsive width_section" >
                            <form type="get" action="." style="margin: 0">
                                {%if widget_obj.slug != 'benificiary-data' and widget_obj.slug != 'disha-benificiary-data' and widget_obj.slug != 'nayan-benificiary-data' and widget_obj.slug != 'custom-report' %}
                                <!-- date filetr start-->
                                <!-- <div class="col-lg-4">
                                    <div class="datetime_picker">
                                        <input type="text" name="from_date" title="Select From Date" class = "datepicker form-control" id="id_start_date" value="{% if filter_from_date %}{{filter_from_date}}{% endif %}" placeholder="From Date" autocomplete="off">
                                    </div>
                                    <div class="datetime_picker">
                                       <input type="text" name="to_date" title="Select To Date" class = "datepicker form-control" id="id_end_date" placeholder="To Date" value="{% if filter_to_date %}{{filter_to_date}}{% endif %}" onclick="myFunction()" autocomplete="off">
                                    </div>
                                </div> -->
                                    <div class="col-md-6 " {% if search_filter_value != '' %} style="display: flex;" {% else %}  style="display: none;" {% endif %} id = 'search_button'>
                                        <div class="col-md-6 p-1" >
                                            <input class="form-control col-md-6" data-width="50%" id="search_box" type="text" name="search_box"  placeholder="Search..." value = "{{search_filter_value}}">
                                        </div>
                                        <div class="p-1">
                                            <!-- <button id="search_submit" type="submit" onclick="checkLength()" >Submit</button> -->
                                            <button class="btn btn-primary btn-sm" id="search_submit" type="submit" >Search</button>
                                            <a href="/reports/exportcsv/{{report_slug}}/" class="btn btn-danger btn-sm btn_load"> Reset </a>
                                            
                                        </div>

                                    </div>
                                <!-- date filetr end -->

                                <!-- flatpicker date -->

                                <!-- flatpicker date end -->
                                <!-- Theme filter start-->
                                 <!-- <div class="col-md-6" id="div_{{level.code}}">
                                    <div class="">
                                        <div class="form-group label-floating select_group">
                                            <spen>Themes</spen>
                                            <select class="selectpicker" data-style="select-with-transition" name="theme" id="id_theme" data-live-search="true" multiple>
                                                <option value="">Select Themes</option>
                                                {% for theme in theme_list %}
                                                    <option value="{{project.id}}">{{theme.name}}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div> -->
                                
                                <!--theme filter end-->
                                <!-- project filter start-->
                                
                                <!-- <div class="col-md-6" id="div_{{level.code}}">
                                    <div class="">
                                        <div class="form-group label-floating select_group">
                                            <spen>Projects</spen>
                                            <select class="selectpicker" data-style="select-with-transition" name="Project" id="id_project" data-live-search="true" multiple="multiple" >
                                                <option value="">Select Projects</option>
                                                {% for project in projectlist %}
                                                    <option value="{{project.id}}" {% if project.id in project_list_id  %}selected{% endif %}>{{project.id}}_{{project.name}}</option>
                                                {% endfor %}
                                            </select>
                                        </div> 
                                    </div>
                                </div> -->
                                
                                <!-- project filter end-->
                                
                                
                                

                                <!-- location  filter start  -->
                              
                                    <div class="filter_class d-flex flex-wrap">
                                        <div class="p-1 col-12 col-md-6" id="div_{{level.code}}">
                                            <div class="">
                                                <div class="form-group label-floating select_group">
                                                    <span>Partners<span class="required">*</span> 
                                                  </span>
                                                    <select class="selectpicker select2 " data-width="100%" data-style="select-with-transition" name="partner" id="id_partner" data-live-search="true" multiple="multiple">
                                                        <option value="" disabled >Select Partners</option>
                                                        {% for part in partnerlist %}
                                                            <option value="{{part.id}}" {% if part.id|slugify in partner_list_str  %}selected{% endif %}>{{part.name}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div> 
                                            </div>
                                        </div>
                                        
                                        <form class="d-flex flex-wrap" action="." method='GET' id="survey">
                                    
                                        <div class="p-1 col-12 col-md-6" id="div_{{level.code}}">
                                            <div class="">
                                                <div class="form-group label-floating select_group">
                                                    <spen>Schools</spen>
                                                    <select class="selectpicker select2" data-width="100%"   data-style="select-with-transition" name="school" id="id_school" data-live-search="true" multiple>
                                                        {% for scl in school_list %}
                                                        <option value="{{scl.0}}" {% if scl.0|slugify in school_list_str %}selected{% endif %}>{{scl.1}}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    
                            {%endif%}
                                
                                        <div class="col-6 col-md-6 mt-md-4">
                                            <div class="d-flex justify-content-between" >
                                                {%if widget_obj.slug not in "'custom-report','benificiary-data','disha-benificiary-data','nayan-benificiary-data'" %}
                                                <div class="p d-flex" style="position: relative; left:10px; top: 8.5px !important; gap:10px">
                                                    <!-- <input  id="search_box" type="text" name="search_box"  placeholder="Search..." > -->
                                                    <!-- <button id="search_submit" type="submit" onclick="checkLength()" >Submit</button> -->
                                                    <button id="search_submit" class="btn btn-primary btn-sm " type="submit" >Submit</button>
                                                    <a href="/reports/exportcsv/{{report_slug}}/" class="btn btn-danger btn-sm btn_load"> Reset </a>
        
                                                </div>
                                                {%endif%}
                                                
                                            </div>
                                        </div>
                                    
                            </form>
                            <br>
                            <br>
                            <br>
                            <table id="datatables" class="table table-striped" cellspacing="0">
                            <thead class="table-light" >
                                <th  >SI No</th>
                            {% for loc in qlist %}
                                <th  >{{loc}}</th>
                            {% endfor %}
                            </thead>
                            <tbody style="font-size: 0.8125rem;">
                            {% if object_list %}
                                {% for i in object_list %}
                                <tr>
                                    <td>{{forloop.counter0|add:start_index}}</td>
                                    {% for k in i %}
                                        <td>{{k}}</td>
                                    {% endfor %}
                                       
                                    {%if report_slug in "'export-reports'" or "benificiary-data" in report_slug and i.2 != '-' %}<td>
                                    <a href="#" onclick="export_csv('{{i.0}}')">Download</a>
                    <!-- <a href="javascript:onclickFunction('id')">Download</a>     -->
                                    </td>
                                    {% elif report_slug == 'custom-report' and i.2 != '-' %}<td>
                                        <a href="/reports/custom-report-csv/{{i.0}}/">Download</a>
                        <!-- <a href="javascript:onclickFunction('id')">Download</a>     -->
                                        </td>
                                    {%else%}
                                    <td>&nbsp;</td>
                                    {%endif%}
                                {% endfor %}
                                </tr>
                            {% else %}
                                    <td class="text-primary">No records found</td>
                            {% endif %}
                            </tbody>
                        </table>
                      
                    </div>
                        {% if object_list %}
                        {% include 'reports/custom_pagination.html' %}
                        <!-- {% include 'survey_forms/pagination.html' %} -->
                        {% endif %}
                </div>
            </div>
        </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_javascript%}
<!--<script src="/static/assets/js/jquery-3.2.1.min.js" type="text/javascript"></script>-->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<script>
    function show_or_hide_filter(){
        console.log('hereeeeeeeeeeeeeeeeeee')
        if (document.getElementById("search_button").style.display == 'none'){
            document.getElementById("search_button").style.display = 'inline';
              
        }
        else{
            document.getElementById("search_button").style.display = 'none';
        }
      };

</script>
<script>
    function export_csv(survey_id) {
        var data = {'partner_id[]':$("#id_partner").val(),'schools_id[]':$('#id_school').val(),'survey_id':survey_id}
        const queryString = $.param(data);
        window.location.href = '/export_data/file-download/?'+queryString
    }
  $( function() {
    $(".datepicker").datepicker({
            currentText : "Now",
            maxDate : '0',
            dateFormat:"yy-mm-dd",
            onSelect: function (selected) {
                var dt = new Date(selected);
                dt.setDate(dt.getDate() + 0);
                $("#ed").datepicker("option", "minDate", dt);
            }
        });

        $(".datepicker").datepicker({
            currentText: "Now",
            maxDate : '0',
            dateFormat:"yy-mm-dd",
            onSelect: function (selected) {
                var dt = new Date(selected);
                dt.setDate(dt.getDate() - 0);
                $("#sd").datepicker("option", "maxDate", dt);
            }
        });
  });

    function myFunction() {
    var input, filter, ul, li, a, i, txtValue;
    input = document.getElementById("myInput");
    filter = input.value.toUpperCase();
    ul = document.getElementById("myUL");
    li = ul.getElementsByTagName("li");
    debugger;
    for (i = 0;i < li.length; i++) {
        a = li[i].getElementsByTagName("a")[0];
        txtValue = a.textContent || a.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
            li[i].style.display = "";
        } else {
            li[i].style.display = "none";
        }
    }
}

function checkLength(){
    var textbox = document.getElementById("search_box");
    if(textbox.value.length <= 2 ){
        alert("Text is short, Minimum 3 Charaters required")
    }
}

</script>

<!-- location filter scripts -->
<script>
    $(document).ready(function() {
        $("#id_partner").on('change', function(){
            $.ajax({
               type:"POST",
               url:"/ajax/report_school/",
               dataType: "json",
               data: {'partner_id[]':$("#id_partner").val(),'user_id': '{{request.user.id}}'},
               success: function(d) {
                   debugger;
                   if (d) {    
                        var res = d;
                        $('#id_school').find('option').remove().end();
                        for (i=0;i<res.length;i++) {
                        console.log(res.id,res.name)
                        if(Number('{{request.GET.partner_id}}') == res.id){
                            $('<option>', {value : res[i].id}).html(res[i].name).appendTo('#id_school' ).attr('selected', 'selected')
                        }
                        else{
                            $('<option>', {value : res[i].id }).html(res[i].name).appendTo('#id_school');
                        }
                        }
                    }
                }
            });
        });
        });
    </script>
    


{% endblock %}
